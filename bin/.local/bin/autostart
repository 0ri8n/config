#!/usr/bin/env ruby

# ---
# title:  autostart
# author: emil lenz
# email:  emillenz@protonmail.com
# date:   2023-05-07
# info:
# - starting daemons (emacs, tmux) and background processes (if not running)
# - running commands (to set some behaviour)
# ---

def main
	spawn_processes
	CMDS.each { |cmd| system(cmd) }
end

def spawn_processes
	processes = `ps -e -o comm`.lines.drop(0).map(&:chomp)

	PROCESSES.each do |ps|
		name = ps[1] || ps[0].split[0]

		if processes.include?(name)
			puts "[exists] #{name}"
		else
			Process.detach(Process.spawn(ps[0], %i[out err] => File::NULL))
			puts "[started] #{name} '#{ps[0]}'"
		end
	end
end

CMDS = [
	"xsetroot -solid '#ffffff'", # minimalist modus-vivendi bg color

	# no auto screensaving
	"xset dpms 0 0 0",
	"xset s off",

	"xset r off" # disable key repeat (efficiency!)
].freeze

PROCESSES = [
	["nohup xremap-x11 --watch=device --watch=config #{ENV['HOME']}/.config/xremap/config.yml", "xremap-x11"],
	["emacsclient --reuse-frame || (emacs --daemon && emacsclient --create-frame)"],
	["firefox"],
	["playerctld"],
	["unclutter"],
	["batsignal -bpe -w 50 -c 20 -d 5"],
	["nm-applet"]
].freeze

main
