#!/usr/bin/env ruby
#  ---
#  title:  blutoothconnect menu
#  author: emil lenz
#  email:  emillenz@protonmail.com
#  date:   2024-05-26
#  dependecies: bluetoothctl
#  ---

require 'open3'
require 'English'

DMENU_CMD = [
        'dmenu',
        '-b',
        '-i',
        '-fn', 'Iosevka Comfy-10',
        '-nb', '#ffffff',
        '-nf', '#000000',
        '-sb', '#c0deff',
        '-sf', '#000000',
        '-p',  'bluetooth-menu >'
].freeze

def main
        addresses = `bluetoothctl devices`.split("\n").map do |line|
                words = line.split
                name = words[2..].join(' ')
                addr = words[1]
                [name, addr]
        end.to_h

        selected = menu_select(addresses.keys.push('!off'))
        case selected
        when '!off'
                disconnect
        else
                connect(selected, addresses)
        end
end

def menu_select(items)
        selected, status = Open3.capture2(*DMENU_CMD, stdin_data: items.join("\n"))
        exit(1) unless status.success?
        selected.chomp
end

def connect(device_name, addresses)
        `bluetoothctl power on`
        `bluetoothctl connect #{addresses[device_name]}`
        exit(1) unless $CHILD_STATUS.success?
        `dunstify 'bluetooth connected' "#{device_name}"`
end

def disconnect
        `bluetoothctl power off`
        `dunstify 'bluetooth off'`
end

main
