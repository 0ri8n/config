#!/usr/bin/env ruby
#  ---
#  title:  blutoothconnect menu
#  author: emil lenz
#  email:  emillenz@protonmail.com
#  date:   2024-05-26
#  dependecies: bluetoothctl, dmenu
#  ---

require 'open3'
require 'English'

# ARGV := arguments to pass to dmenu
def main
	addresses = `bluetoothctl devices`.split("\n").map do |line|
		words = line.split
		name = words[2..].join(' ')
		addr = words[1]
		[name, addr]
	end.to_h

	input = addresses.keys.push("off").join("\n")

	selected, status = Open3.capture2(
		'dmenu',
		'-p',
		"#{File.basename($PROGRAM_NAME)} >",
		*ARGV,
		stdin_data: input
	)

	exit(1) unless status.success?
	selected = selected.chomp

	case selected
	when "off"
		poweroff
	else
		connect(selected, addresses)
	end
end

def connect(device_name, addresses)
	`bluetoothctl power on`
	`bluetoothctl connect #{addresses[device_name]}`
	exit(1) unless $CHILD_STATUS.success?
	`dunstify 'bluetooth connected' "#{device_name}"`
end

def poweroff
	`bluetoothctl power off`
	`dunstify 'bluetooth off'`
end

main
