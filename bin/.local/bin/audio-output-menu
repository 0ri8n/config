#!/usr/bin/env ruby
# ---
# title:  audio output selection menu
# author: emil lenz
# email:  emillenz@protonmail.com
# date:   2023-05-07
# dependencies:
# - rofi, pactl
# ---

require 'json'
require 'open3'
require 'English'


DMENU_CMD = [
        'dmenu',
        '-b',
        '-i',
        '-fn', 'Iosevka Comfy-10',
        '-nb', '#ffffff',
        '-nf', '#000000',
        '-sb', '#c0deff',
        '-sf', '#000000',
        '-p',  'audio-output >'
].freeze

def main
        sinks = JSON.parse(`pactl --format json list sinks`)

        stdin = sinks.map { |sink| sink['description'] }.join("\n")

        read, status = Open3.capture2(*DMENU_CMD, stdin_data: stdin)
        exit(1) unless status.success?

        sink_id = sinks.find { |sink| sink['description'] == read.chomp }['index']

        `pactl set-default-sink #{sink_id}`
        exit 1 unless $CHILD_STATUS.success?

        JSON.parse(`pactl --format json list sink-inputs`).map do |sink|
                `pactl move-sink-input #{sink['index']} #{sink_id}`
        end

        `dunstify 'audio-output changed' "#{read}"`
end

main
