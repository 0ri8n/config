#!/usr/bin/env ruby
# ---
# title:  killprocess menu
# author: emil lenz
# email:  emillenz@protonmail.com
# date:   2023-05-08
# dependencies:
# - rofi
# ---

require 'open3'
require 'English'

DMENU_CMD = [
        'dmenu',
        '-b',
        '-i',
        '-fn', 'Iosevka Comfy-10',
        '-nb', '#ffffff',
        '-nf', '#000000',
        '-sb', '#c0deff',
        '-sf', '#000000',
        '-p',  'killprocess >'
].freeze


def main
        processes = `ps -e -o pid,comm`.lines.drop(1).map do |line|
                columns = line.strip.split(/\s+/)
                pid = columns[0]
                name = columns[1..].join(' ')
                [name, pid]
        end.to_h

        stdin = processes.keys.join("\n")
        select, status = Open3.capture2(*DMENU_CMD, stdin_data: stdin)
        exit 1 unless status.success?
        ps_id = processes[select.chomp]

        `sudo kill #{ps_id}`
        exit 1 unless $CHILD_STATUS.success?
        `dunstify 'killprocess' "#{select}`
end

main
